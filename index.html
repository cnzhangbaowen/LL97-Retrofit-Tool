<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NYC LL97 Compliance Tool v3.1</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    
    <style>
        :root { --primary: #0d6efd; --success: #198754; --danger: #dc3545; --bg: #f8f9fa; }
        body { background-color: var(--bg); font-family: 'Segoe UI', sans-serif; padding-bottom: 50px; }
        .hero { background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%); color: white; padding: 2rem 0; margin-bottom: 2rem; }
        .card { border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-radius: 10px; margin-bottom: 1.5rem; }
        .card-header { background: white; font-weight: 700; border-bottom: 1px solid #eee; padding: 1rem; color: #333; }
        .input-group-text { min-width: 100px; font-weight: 500; font-size: 0.9rem; }
        
        /* ÂÖ≥ÈîÆ‰øÆÂ§çÔºöÂº∫Âà∂ÁªôÂõæË°®ÂÆπÂô®È´òÂ∫¶ */
        .chart-wrapper { position: relative; height: 350px; width: 100%; }
        .pie-wrapper { position: relative; height: 250px; width: 100%; display: flex; justify-content: center; }
        
        .btn-calc { padding: 12px; font-weight: bold; font-size: 1.1rem; letter-spacing: 0.5px; }
    </style>
</head>
<body>

<div class="hero text-center">
    <div class="container">
        <h1>NYC Local Law 97 Decision Support Tool</h1>
        <p class="opacity-75">Multi-typology Compliance & Economic Analysis</p>
        <span class="badge bg-light text-primary">Version 3.1 (Stable Fix)</span>
    </div>
</div>

<div class="container">
    <div class="row">
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">üè¢ Building Profile</div>
                <div class="card-body">
                    <form id="mainForm" onsubmit="event.preventDefault(); runSimulation();">
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold small text-muted">BUILDING TYPE (LL97 CATEGORY)</label>
                            <select class="form-select" id="bldgType" required></select>
                        </div>

                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <label class="form-label small text-muted">GROSS AREA</label>
                                <input type="number" class="form-control" id="area" value="50000" min="25000" required>
                                <div class="form-text text-danger" id="areaError" style="display:none; font-size:0.7rem;">Must be > 25,000 sq ft</div>
                            </div>
                            <div class="col-6">
                                <label class="form-label small text-muted">BUILT YEAR</label>
                                <input type="number" class="form-control" id="year" value="1960" min="1800" max="2024">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold small text-muted">ANNUAL ENERGY CONSUMPTION</label>
                            
                            <div class="input-group input-group-sm mb-2">
                                <span class="input-group-text">‚ö° Elec</span>
                                <input type="number" class="form-control" id="elec" value="650000">
                                <span class="input-group-text">kWh</span>
                            </div>

                            <div class="input-group input-group-sm mb-2">
                                <span class="input-group-text">üî• Gas</span>
                                <input type="number" class="form-control" id="gas" value="45000">
                                <span class="input-group-text">Therm</span>
                            </div>

                            <div class="input-group input-group-sm mb-2">
                                <span class="input-group-text">üí® Steam</span>
                                <input type="number" class="form-control" id="steam" value="0">
                                <span class="input-group-text">Mlbs</span>
                            </div>

                            <div class="input-group input-group-sm mb-2">
                                <span class="input-group-text">üõ¢Ô∏è Oil #2</span>
                                <input type="number" class="form-control" id="oil2" value="2000">
                                <span class="input-group-text">Gal</span>
                            </div>

                            <div class="input-group input-group-sm mb-2">
                                <span class="input-group-text">üõ¢Ô∏è Oil #4</span>
                                <input type="number" class="form-control" id="oil4" value="0">
                                <span class="input-group-text">Gal</span>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold small text-muted">RETROFIT BUDGET ($)</label>
                            <input type="number" class="form-control" id="budget" value="150000">
                        </div>

                        <button type="submit" class="btn btn-primary w-100 btn-calc">Run Analysis üöÄ</button>
                    </form>
                </div>
            </div>

            <div class="card">
                <div class="card-header">Energy Breakdown</div>
                <div class="card-body">
                    <div class="pie-wrapper">
                        <canvas id="pieChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between">
                    <span>üìä Compliance Timeline & Penalty Analysis</span>
                    <span class="badge bg-danger bg-opacity-10 text-danger">Penalty Rate: $268/tCO2e</span>
                </div>
                <div class="card-body">
                    <div class="chart-wrapper">
                        <canvas id="barChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">üí° Optimized Retrofit Plan</div>
                <div class="card-body table-responsive p-0">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-3">Priority</th>
                                <th>Measure</th>
                                <th>Cost ($)</th>
                                <th>Savings ($/yr)</th>
                                <th>Payback</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="ecmTable">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <footer class="text-center text-muted small mt-4">
        &copy; 2025 Baowen Zhang. Data Sources: NYC LL97 & User Collected Field Data.
    </footer>
</div>

<script>
    // --- 1. DATA: Building Types & Limits ---
    const BUILDING_DATA = {
        "Multifamily (R2)":         [0.00675, 0.00407, 0.0014, 0.0014, 0.0014],
        "Assemble (A)":             [0.01074, 0.00420, 0.0014, 0.0014, 0.0014],
        "College/University (A3)":  [0.01074, 0.00420, 0.0014, 0.0014, 0.0014],
        "Education (E)":            [0.00758, 0.00344, 0.0014, 0.0014, 0.0014],
        "Food Service (M)":         [0.01138, 0.00403, 0.0014, 0.0014, 0.0014],
        "Health Care (L2)":         [0.02381, 0.01193, 0.0014, 0.0014, 0.0014],
        "Technology/Science (I-1)": [0.01138, 0.00598, 0.0014, 0.0014, 0.0014],
        "Lodging/Hotel (R1)":       [0.00987, 0.00526, 0.0014, 0.0014, 0.0014],
        "Manufacturing (F)":        [0.00574, 0.00167, 0.0014, 0.0014, 0.0014],
        "Office/Business (B)":      [0.00846, 0.00453, 0.0014, 0.0014, 0.0014],
        "Retail/Mercantile (M)":    [0.01181, 0.00403, 0.0014, 0.0014, 0.0014],
        "Services/Utility (U)":     [0.00426, 0.00110, 0.0014, 0.0014, 0.0014],
        "Storage (S)":              [0.00426, 0.00110, 0.0014, 0.0014, 0.0014]
    };

    // --- 2. FACTORS ---
    const COF = {
        ELEC: 0.000288962,
        GAS:  0.005311,
        STEAM: 0.04493,
        OIL2: 0.01024,
        OIL4: 0.01099
    };

    // --- 3. ECM DB ---
    const ECM_DB = [
        { name: "Upgrade to LED Lighting", costRatio: 1.2, eSave: 0.15, fuelSave: -0.01 },
        { name: "HVAC Insulation Upgrade", costRatio: 0.8, eSave: 0.00, fuelSave: 0.08 },
        { name: "Install Heat Pump System", costRatio: 15.0, eSave: -0.20, fuelSave: 0.60 },
        { name: "Boiler Efficiency Retrofit", costRatio: 3.5, eSave: 0.00, fuelSave: 0.12 },
        { name: "Water Level Controls", costRatio: 0.5, eSave: 0.01, fuelSave: 0.03 },
        { name: "High-Performance Windows", costRatio: 28.0, eSave: 0.02, fuelSave: 0.10 }
    ];

    let barChart = null;
    let pieChart = null;

    window.onload = function() {
        const sel = document.getElementById('bldgType');
        Object.keys(BUILDING_DATA).forEach(type => {
            const opt = document.createElement('option');
            opt.value = type;
            opt.innerText = type;
            sel.appendChild(opt);
        });
        // Ëá™Âä®ËøêË°å‰∏ÄÊ¨°Ê®°ÊãüÔºåÁ°Æ‰øùÈ°µÈù¢‰∏ÄÊâìÂºÄÂ∞±ÊúâÂõæ
        runSimulation();
    };

    function runSimulation() {
        const type = document.getElementById('bldgType').value;
        const area = parseFloat(document.getElementById('area').value);
        if(area < 25000) { document.getElementById('areaError').style.display = 'block'; return; }
        document.getElementById('areaError').style.display = 'none';

        const u = {
            elec: parseFloat(document.getElementById('elec').value) || 0,
            gas: parseFloat(document.getElementById('gas').value) || 0,
            steam: parseFloat(document.getElementById('steam').value) || 0,
            oil2: parseFloat(document.getElementById('oil2').value) || 0,
            oil4: parseFloat(document.getElementById('oil4').value) || 0
        };
        const budget = parseFloat(document.getElementById('budget').value) || 0;

        const currentEmiss = (u.elec * COF.ELEC) + (u.gas * COF.GAS) + (u.steam * COF.STEAM) + (u.oil2 * COF.OIL2) + (u.oil4 * COF.OIL4);

        updatePieChart(u);
        let bestECMResults = calcBestECM(u, area, budget, currentEmiss, type);
        
        // Time Series
        const limits = BUILDING_DATA[type];
        const timeLabels = ["2024-29", "2030-34", "2035-39", "2040-49", "2050+"];
        
        let preData = [], postData = [], limitLine = [], savedTags = [];

        limits.forEach((limitFactor, i) => {
            const limitTons = limitFactor * area;
            limitLine.push(limitTons);

            preData.push(currentEmiss);
            let prePenalty = Math.max(0, (currentEmiss - limitTons) * 268);

            let gridClean = 1.0; 
            if(i > 1) gridClean = 0.8;
            if(i > 3) gridClean = 0.6;

            const postE_adj = bestECMResults.newEmiss * gridClean; 
            postData.push(postE_adj);
            
            let postPenalty = Math.max(0, (postE_adj - limitTons) * 268);
            let saved = prePenalty - postPenalty;
            savedTags.push(saved > 100 ? "$" + (saved/1000).toFixed(0) + "k" : "");
        });

        updateBarChart(timeLabels, preData, postData, limitLine, savedTags);
        updateTable(bestECMResults.list, budget);
    }

    function calcBestECM(u, area, budget, currentEmiss, type) {
        let list = [];
        const bill = (u.elec*0.22) + (u.gas*1.1) + (u.steam*2.5) + (u.oil2*4.0) + (u.oil4*3.8);

        ECM_DB.forEach(ecm => {
            const cost = ecm.costRatio * area * 0.5;
            const newU = {
                elec: u.elec * (1 - ecm.eSave),
                gas: u.gas * (1 - ecm.fuelSave),
                steam: u.steam * (1 - ecm.fuelSave),
                oil2: u.oil2 * (1 - ecm.fuelSave),
                oil4: u.oil4 * (1 - ecm.fuelSave)
            };
            const newEmiss = (newU.elec * COF.ELEC) + (newU.gas * COF.GAS) + (newU.steam * COF.STEAM) + (newU.oil2 * COF.OIL2) + (newU.oil4 * COF.OIL4);
            const newBill = (newU.elec*0.22) + (newU.gas*1.1) + (newU.steam*2.5) + (newU.oil2*4.0) + (newU.oil4*3.8);

            const limit2030 = BUILDING_DATA[type][1] * area;
            const penNow = Math.max(0, (currentEmiss - limit2030) * 268);
            const penNew = Math.max(0, (newEmiss - limit2030) * 268);
            
            const savings = (bill - newBill) + (penNow - penNew);
            const payback = savings > 0 ? cost / savings : 999;

            list.push({ ...ecm, cost, savings, payback, newEmiss });
        });

        list.sort((a,b) => a.payback - b.payback);
        
        let finalEmiss = currentEmiss;
        let spent = 0;
        list.forEach(item => {
            if(item.payback < 10 && spent + item.cost < budget * 1.5) {
                finalEmiss = item.newEmiss;
                spent += item.cost;
            }
        });

        return { list, newEmiss: finalEmiss };
    }

    // --- CHARTS (Fixed Version) ---
    function updatePieChart(u) {
        // Convert to kBtu
        const kbtu = [u.elec*3.412, u.gas*100, u.steam*1000, u.oil2*138, u.oil4*146];
        const ctx = document.getElementById('pieChart').getContext('2d');
        if(pieChart) pieChart.destroy();

        pieChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Elec', 'Gas', 'Steam', 'Oil #2', 'Oil #4'],
                datasets: [{
                    data: kbtu,
                    backgroundColor: ['#0d6efd', '#198754', '#ffc107', '#fd7e14', '#dc3545']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false, // ÂÖ≥ÈîÆ‰øÆÂ§ç
                plugins: { legend: { position: 'right' } }
            }
        });
    }

    function updateBarChart(labels, pre, post, limits, savedTags) {
        const ctx = document.getElementById('barChart').getContext('2d');
        if(barChart) barChart.destroy();
        
        // Ê≥®ÂÜåÊèí‰ª∂ (3.x ËØ≠Ê≥ï)
        Chart.register(ChartDataLabels);

        barChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        type: 'line', label: 'LL97 Limit', data: limits,
                        borderColor: '#dc3545', borderDash: [5,5], borderWidth: 2, pointRadius: 0, order: 0,
                        datalabels: { display: false }
                    },
                    {
                        label: 'Baseline', data: pre, backgroundColor: '#adb5bd', order: 2,
                        datalabels: { display: false }
                    },
                    {
                        label: 'With Retrofit', data: post, backgroundColor: '#198754', order: 1,
                        datalabels: {
                            anchor: 'end', align: 'top', color: '#198754', font: {weight:'bold'},
                            formatter: (val, ctx) => savedTags[ctx.dataIndex]
                        }
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false, // ÂÖ≥ÈîÆ‰øÆÂ§ç
                plugins: {
                    datalabels: { display: true },
                    tooltip: { callbacks: { label: (c) => Math.round(c.raw) + " tCO2e" } }
                },
                scales: {
                    y: { beginAtZero: true, title: { display:true, text:'tCO2e / Year' } }
                }
            }
        });
    }

    function updateTable(list, budget) {
        const tbody = document.getElementById('ecmTable');
        tbody.innerHTML = '';
        let cumCost = 0;
        list.forEach(item => {
            cumCost += item.cost;
            let badge = item.payback < 3 ? '<span class="badge bg-danger">High Priority</span>' : (item.payback < 8 ? '<span class="badge bg-warning text-dark">Medium</span>' : '<span class="badge bg-success">Long Term</span>');
            const status = cumCost <= budget ? '<span class="text-success fw-bold">‚úì Funded</span>' : '<span class="text-muted">Waitlist</span>';
            tbody.innerHTML += `<tr><td>${badge}</td><td>${item.name}</td><td>$${item.cost.toLocaleString(undefined,{maximumFractionDigits:0})}</td><td>$${item.savings.toLocaleString(undefined,{maximumFractionDigits:0})}</td><td>${item.payback.toFixed(1)} yrs</td><td>${status}</td></tr>`;
        });
    }
</script>
</body>
</html>
