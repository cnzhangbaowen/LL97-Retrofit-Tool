<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LL97 Decarbonization Decision Support Tool v2.0</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    
    <style>
        :root {
            --primary-blue: #1a4f78;
            --accent-green: #2ecc71;
            --alert-red: #e74c3c;
            --bg-light: #f8f9fa;
        }
        body { background-color: var(--bg-light); font-family: 'Segoe UI', Roboto, sans-serif; }
        
        /* È°∂ÈÉ® Hero Âå∫Âüü */
        .hero-header {
            background: linear-gradient(135deg, var(--primary-blue) 0%, #2980b9 100%);
            color: white;
            padding: 3rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        /* Âç°ÁâáÊ†∑Âºè */
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 1.5rem;
            transition: transform 0.2s;
        }
        .card:hover { transform: translateY(-2px); }
        .card-header {
            background-color: white;
            border-bottom: 1px solid #eee;
            font-weight: 700;
            color: var(--primary-blue);
            padding: 1rem 1.5rem;
            border-radius: 12px 12px 0 0 !important;
        }

        /* Êé®ËçêË°®Ê†º */
        .badge-priority-high { background-color: #e74c3c; color: white; }
        .badge-priority-med { background-color: #f39c12; color: white; }
        .badge-priority-low { background-color: #27ae60; color: white; }
        
        /* ËÉΩÊ∫êÊòéÁªÜÂ∞èÂ≠ó */
        .energy-delta { font-size: 0.85rem; font-weight: 500; }
        .text-up { color: #e67e22; } /* Â¢ûÂä† */
        .text-down { color: #27ae60; } /* ÂáèÂ∞ë */

        /* ÊåâÈíÆ */
        .btn-run {
            background-color: var(--primary-blue);
            border: none;
            padding: 12px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        .btn-run:hover { background-color: #123755; }
    </style>
</head>
<body>

<div class="hero-header text-center">
    <div class="container">
        <h1 class="display-5 fw-bold">NYC Local Law 97 Decision Support Tool</h1>
        <p class="lead opacity-75">Integrated Machine Learning Approach for Economic Retrofit Prioritization</p>
        <span class="badge bg-light text-dark bg-opacity-75">Model: Stacked Ensemble v2.0 (Grid-Aware)</span>
    </div>
</div>

<div class="container">
    <div class="row">
        <div class="col-lg-3">
            <div class="card">
                <div class="card-header">üè¢ Building Profile</div>
                <div class="card-body">
                    <form id="ll97Form" onsubmit="event.preventDefault(); runSimulation();">
                        <div class="mb-3">
                            <label class="form-label small text-muted text-uppercase fw-bold">Parameters</label>
                            <select class="form-select mb-2" id="bldgType" required>
                                <option value="Multifamily" selected>Multifamily Building</option>
                                <option value="Commercial" disabled>Commercial (Coming Soon)</option>
                            </select>
                            
                            <div class="row g-2">
                                <div class="col-6">
                                    <input type="number" class="form-control" id="area" placeholder="Area (sq ft)" value="85000" min="25000" required>
                                    <div class="form-text" style="font-size: 0.7rem">Min 25,000</div>
                                </div>
                                <div class="col-6">
                                    <input type="number" class="form-control" id="year" placeholder="Year" value="1950" min="1800" max="2024" required>
                                </div>
                            </div>
                            <input type="text" class="form-control mt-2" id="zipcode" placeholder="Zip Code (e.g. 10001)" pattern="[0-9]{5}" required>
                        </div>

                        <hr class="my-3">

                        <div class="mb-3">
                            <label class="form-label small text-muted text-uppercase fw-bold">Annual Energy Use</label>
                            
                            <div class="input-group input-group-sm mb-2">
                                <span class="input-group-text">‚ö° Elec</span>
                                <input type="number" class="form-control" id="elec" value="1250000">
                                <span class="input-group-text">kWh</span>
                            </div>

                            <div class="input-group input-group-sm mb-2">
                                <span class="input-group-text">üî• Gas</span>
                                <input type="number" class="form-control" id="gas" value="45000">
                                <span class="input-group-text">Therm</span>
                            </div>

                            <div class="input-group input-group-sm mb-2">
                                <span class="input-group-text">üí® Steam</span>
                                <input type="number" class="form-control" id="steam" value="0">
                                <span class="input-group-text">Mlbs</span>
                            </div>

                            <div class="input-group input-group-sm mb-2">
                                <span class="input-group-text">üõ¢Ô∏è Oil #2</span>
                                <input type="number" class="form-control" id="oil2" value="2000">
                                <span class="input-group-text">Gal</span>
                            </div>

                            <div class="input-group input-group-sm mb-2">
                                <span class="input-group-text">üõ¢Ô∏è Oil #4</span>
                                <input type="number" class="form-control" id="oil4" value="0">
                                <span class="input-group-text">Gal</span>
                            </div>
                        </div>

                        <hr class="my-3">

                        <div class="mb-3">
                            <label class="form-label small text-muted text-uppercase fw-bold">Constraints</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">$ Budget</span>
                                <input type="number" class="form-control" id="budget" value="200000">
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary w-100 btn-run">Run Simulation üöÄ</button>
                    </form>
                </div>
            </div>

            <div class="card bg-light">
                <div class="card-body pt-2 pb-2">
                    <h6 class="small fw-bold text-muted mb-2">PROJECTED IMPACT</h6>
                    <div id="impactDisplay" class="opacity-50">
                        <small class="d-block text-muted">Run simulation to see details...</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-9">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>üìä Compliance Timeline & Financial Impact (2024-2050)</span>
                    <span class="badge bg-primary bg-opacity-10 text-primary">Dynamic Grid Decarbonization Enabled</span>
                </div>
                <div class="card-body">
                    <div style="height: 400px; width: 100%;">
                        <canvas id="complianceChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">üí° Optimized ECM Sequence</div>
                <div class="card-body table-responsive p-0">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4">Priority</th>
                                <th>Conservation Measure</th>
                                <th>Est. Cost</th>
                                <th>Annual Savings</th>
                                <th>Payback</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="ecmTableBody">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <footer class="mt-5 mb-5 text-center text-muted small">
        <p>Developed for Journal of Building Engineering Submission.</p>
        <p>&copy; 2025 Baowen Zhang & Paul Crovella. SUNY ESF.</p>
    </footer>
</div>

<script>
    // --- 1. ÁßëÂ≠¶Â∏∏Êï∞ÂÆö‰πâ (Based on NYC LL97 Law & Bulletins) ---
    // Á¢≥ÊéíÊîæÂõ†Â≠ê (tCO2e per unit)
    const COF = {
        ELEC_2024: 0.000288962, // 2024-2029 Grid
        ELEC_2030: 0.000145,    // 2030-2034 Grid (Cleaner)
        ELEC_2040: 0.000086,    // 2040+ Grid estimate
        GAS: 0.005311,          // Therm
        STEAM: 0.04493,         // Mlb (District Steam) approx from kBtu factor
        OIL2: 0.01021,          // Gallon
        OIL4: 0.01096           // Gallon (#4 is dirtier)
    };

    // ÁΩöÊ¨æÂçï‰ª∑
    const PENALTY_RATE = 268; 

    // Multifamily ÈôêÈ¢ù (tCO2e/sf) - Article 320
    const LIMITS = {
        P1_2024: 0.00675,
        P2_2030: 0.00407,  // Stricter
        P3_2035: 0.00300,  // Interpolated estimate
        P4_2040: 0.00140,  // Deep cut
        P5_2050: 0.00000   // Net Zero goal
    };

    // ECM Êï∞ÊçÆÂ∫ì (Machine Learning Coefficients Mockup)
    // Ë¥üÊï∞‰ª£Ë°®ËÉΩËÄóÂ¢ûÂä† (ÂâØ‰ΩúÁî®)
    const ECM_DB = [
        { id: 1, name: "Upgrade to LED Lighting", costSqFt: 1.5, elecSave: 0.15, gasSave: -0.01, steamSave: -0.01, oilSave: -0.01 },
        { id: 2, name: "Insulate Heating Pipes", costSqFt: 0.8, elecSave: 0.0, gasSave: 0.08, steamSave: 0.08, oilSave: 0.08 },
        { id: 3, name: "Install Low-Flow Aerators", costSqFt: 0.15, elecSave: 0.0, gasSave: 0.04, steamSave: 0.04, oilSave: 0.04 },
        { id: 4, name: "Upgrade EMS/BMS", costSqFt: 2.5, elecSave: 0.05, gasSave: 0.10, steamSave: 0.10, oilSave: 0.10 },
        { id: 5, name: "Replace Windows (High Perf)", costSqFt: 30.0, elecSave: 0.02, gasSave: 0.12, steamSave: 0.12, oilSave: 0.12 },
        { id: 6, name: "Separate DHW System", costSqFt: 4.0, elecSave: 0.0, gasSave: 0.15, steamSave: 0.15, oilSave: 0.15 }
    ];

    let chartInstance = null;

    // --- 2. Ê†∏ÂøÉÈ™åËØÅ‰∏éËÆ°ÁÆóÈÄªËæë ---
    function runSimulation() {
        // A. ËæìÂÖ•Ëé∑Âèñ‰∏éÈ™åËØÅ
        const area = parseFloat(document.getElementById('area').value);
        const year = parseFloat(document.getElementById('year').value);
        
        if(area < 25000) { alert("LL97 applies to buildings > 25,000 sq ft. Please check Gross Floor Area."); return; }
        if(year < 1800 || year > 2024) { alert("Please enter a valid Building Year (1800-2024)."); return; }

        const usage = {
            elec: parseFloat(document.getElementById('elec').value) || 0,
            gas: parseFloat(document.getElementById('gas').value) || 0,
            steam: parseFloat(document.getElementById('steam').value) || 0,
            oil2: parseFloat(document.getElementById('oil2').value) || 0,
            oil4: parseFloat(document.getElementById('oil4').value) || 0
        };
        const budget = parseFloat(document.getElementById('budget').value) || 0;

        // B. ECM ‰ºòÂåñÁÆóÊ≥ï (ÁÆÄÂåñÁâàË¥™ÂøÉÁÆóÊ≥ï)
        let bestScenario = calculateBestECMScenario(area, usage, budget);

        // C. ÁîüÊàêÊó∂Èó¥ËΩ¥Êï∞ÊçÆ (2024 - 2050)
        // Êàë‰ª¨ËÆ°ÁÆó5‰∏™ÂÖ≥ÈîÆÊó∂Èó¥ÁÇπÁöÑÊï∞ÊçÆÔºöCurrent vs Post-Retrofit
        const timePoints = ['2024-2029', '2030-2034', '2035-2039', '2040-2049', '2050+'];
        const limitsArr = [LIMITS.P1_2024, LIMITS.P2_2030, LIMITS.P3_2035, LIMITS.P4_2040, LIMITS.P5_2050];
        
        let preData = [], postData = [], limitData = [], savingsLabels = [];

        // ÈÅçÂéÜÊØè‰∏™Êó∂Èó¥ÊÆµËÆ°ÁÆó
        timePoints.forEach((tp, idx) => {
            // Ëé∑ÂèñËØ•Êó∂Èó¥ÊÆµÁöÑÁîµÁΩëÂõ†Â≠ê (Grid Decarbonization)
            let gridFactor = COF.ELEC_2024;
            if (idx >= 1) gridFactor = COF.ELEC_2030;
            if (idx >= 3) gridFactor = COF.ELEC_2040;

            // 1. ËÆ°ÁÆó Limit (Tons)
            const limitTons = limitsArr[idx] * area;
            limitData.push(limitTons);

            // 2. ËÆ°ÁÆó Pre-Retrofit Emissions
            const preEmissions = (usage.elec * gridFactor) + 
                                 (usage.gas * COF.GAS) + 
                                 (usage.steam * COF.STEAM) + 
                                 (usage.oil2 * COF.OIL2) + 
                                 (usage.oil4 * COF.OIL4);
            preData.push(preEmissions);

            // 3. ËÆ°ÁÆó Post-Retrofit Emissions
            const postEmissions = (bestScenario.newUsage.elec * gridFactor) + 
                                  (bestScenario.newUsage.gas * COF.GAS) + 
                                  (bestScenario.newUsage.steam * COF.STEAM) + 
                                  (bestScenario.newUsage.oil2 * COF.OIL2) + 
                                  (bestScenario.newUsage.oil4 * COF.OIL4);
            postData.push(postEmissions);

            // 4. ËÆ°ÁÆóËØ•Èò∂ÊÆµÊØèÂπ¥ÁöÑÁΩöÊ¨æËäÇÁúÅ
            let prePenalty = Math.max(0, (preEmissions - limitTons) * PENALTY_RATE);
            let postPenalty = Math.max(0, (postEmissions - limitTons) * PENALTY_RATE);
            let saved = prePenalty - postPenalty;
            
            // Âè™ÊúâÂΩìÊúâÁΩöÊ¨æËäÇÁúÅÊó∂ÊâçÊòæÁ§∫Ê†áÁ≠æ
            savingsLabels.push(saved > 100 ? "$" + (saved/1000).toFixed(1) + "k" : "");
        });

        // D. Êõ¥Êñ∞ UI
        updateChart(timePoints, preData, postData, limitData, savingsLabels);
        updateECMTable(bestScenario.recommendations, budget);
        updateImpactPanel(usage, bestScenario.newUsage);
    }

    // --- 3. ECM ËÆ°ÁÆóÈÄªËæë ---
    function calculateBestECMScenario(area, currentUsage, budget) {
        let recommendations = [];
        let runningUsage = {...currentUsage}; // Âä®ÊÄÅÊõ¥Êñ∞Áî®Èáè
        
        // ÁÆÄÂçïÊ®°ÊãüÔºöËÆ°ÁÆóÊØè‰∏™ECMÁöÑÂçïÁã¨ÂõûÊä•ÔºåÁÑ∂ÂêéÊéíÂ∫è
        // Ê≥®ÊÑèÔºöÁúüÂÆûÊ®°ÂûãÊòØ Stacked Ensemble È¢ÑÊµãÔºåËøôÈáåÁî®Á∫øÊÄßÁ≥ªÊï∞Ê®°Êãü
        ECM_DB.forEach(ecm => {
            const cost = ecm.costSqFt * area;
            
            // ËÆ°ÁÆóËäÇÁúÅÁöÑËÉΩÊ∫êË¥π (Use current prices)
            const oldBill = calcBill(runningUsage);
            
            // È¢ÑÊµãÊñ∞Áî®Èáè
            const newU = {
                elec: runningUsage.elec * (1 - ecm.elecSave),
                gas: runningUsage.gas * (1 - ecm.gasSave),
                steam: runningUsage.steam * (1 - ecm.steamSave),
                oil2: runningUsage.oil2 * (1 - ecm.oilSave),
                oil4: runningUsage.oil4 * (1 - ecm.oilSave)
            };
            
            const newBill = calcBill(newU);
            const billSavings = oldBill - newBill;

            // ÁÆÄÂçïËÆ°ÁÆóÁ¨¨‰∏ÄÂπ¥ÁΩöÊ¨æËäÇÁúÅ (Âü∫‰∫é2024Ê†áÂáÜ)
            const preEmiss = calcEmissions(runningUsage, COF.ELEC_2024);
            const postEmiss = calcEmissions(newU, COF.ELEC_2024);
            const limit = LIMITS.P1_2024 * area;
            const penSave = Math.max(0, (preEmiss - limit)*PENALTY_RATE) - Math.max(0, (postEmiss - limit)*PENALTY_RATE);

            const totalSave = billSavings + penSave;
            const payback = totalSave > 0 ? cost / totalSave : 999;

            recommendations.push({
                ...ecm,
                cost: cost,
                savings: totalSave,
                payback: payback,
                impact: newU // ÊöÇÂ≠òËØ•ECMÂêéÁöÑÁä∂ÊÄÅ
            });
        });

        // ÊéíÂ∫èÔºöPayback Ë∂äÁü≠Ë∂äÂ•Ω
        recommendations.sort((a,b) => a.payback - b.payback);

        // Ë¥™ÂøÉÈÄâÊã©ÔºöÂú®È¢ÑÁÆóÂÜÖÁ¥ØÂä†
        let finalUsage = {...currentUsage};
        let spent = 0;
        
        // ÈáçÊñ∞ÈÅçÂéÜÂ∫îÁî®ÊïàÊûúÔºàÂè†Âä†Ôºâ
        recommendations.forEach(r => {
            if(spent + r.cost <= budget * 1.2) { // ÂÖÅËÆ∏Á®çÂæÆË∂ÖÊ†á‰∏ÄÁÇπ‰Ωú‰∏∫Â±ïÁ§∫
                // Apply savings to final usage
                finalUsage.elec *= (1 - r.elecSave);
                finalUsage.gas *= (1 - r.gasSave);
                finalUsage.steam *= (1 - r.steamSave);
                finalUsage.oil2 *= (1 - r.oilSave);
                finalUsage.oil4 *= (1 - r.oilSave);
                spent += r.cost;
            }
        });

        return { recommendations, newUsage: finalUsage };
    }

    function calcBill(u) {
        return u.elec*0.22 + u.gas*1.1 + u.steam*3.5 + u.oil2*4.0 + u.oil4*3.8; // ‰º∞ÁÆóÂçï‰ª∑
    }

    function calcEmissions(u, gridFactor) {
        return u.elec*gridFactor + u.gas*COF.GAS + u.steam*COF.STEAM + u.oil2*COF.OIL2 + u.oil4*COF.OIL4;
    }

    // --- 4. ÂõæË°®Ê∏≤Êüì (Figure 16 Style) ---
    function updateChart(labels, preData, postData, limitData, savingsTags) {
        const ctx = document.getElementById('complianceChart').getContext('2d');
        if(chartInstance) chartInstance.destroy();

        // Ê≥®ÂÜåÊèí‰ª∂
        Chart.register(ChartDataLabels);

        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'LL97 Limit (Cap)',
                        data: limitData,
                        type: 'line',
                        borderColor: '#e74c3c', // Red Line
                        borderWidth: 2,
                        borderDash: [5, 5],
                        pointRadius: 0,
                        order: 0,
                        datalabels: { display: false }
                    },
                    {
                        label: 'Pre-Retrofit Emissions',
                        data: preData,
                        backgroundColor: '#e74c3c', // Red Bar
                        borderRadius: 4,
                        order: 2,
                        datalabels: { display: false }
                    },
                    {
                        label: 'Post-Retrofit Emissions',
                        data: postData,
                        backgroundColor: '#2ecc71', // Green Bar
                        borderRadius: 4,
                        order: 1,
                        datalabels: {
                            align: 'end',
                            anchor: 'end',
                            color: '#16a085',
                            font: { weight: 'bold', size: 11 },
                            formatter: (value, context) => {
                                return savingsTags[context.dataIndex]; // ÊòæÁ§∫ËäÇÁúÅÈáëÈ¢ù
                            }
                        }
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { 
                        beginAtZero: true, 
                        title: { display: true, text: 'Metric Tons CO2e / Year' },
                        grid: { borderDash: [2, 2] }
                    },
                    x: { grid: { display: false } }
                },
                plugins: {
                    legend: { position: 'top' },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => `${ctx.dataset.label}: ${Math.round(ctx.raw)} tCO2e`
                        }
                    }
                }
            }
        });
    }

    // --- 5. UI Êõ¥Êñ∞ËæÖÂä©ÂáΩÊï∞ ---
    function updateECMTable(recs, budget) {
        const tbody = document.getElementById('ecmTableBody');
        tbody.innerHTML = '';
        let cumCost = 0;

        recs.forEach((r, i) => {
            cumCost += r.cost;
            const isAffordable = cumCost <= budget;
            
            // Priority Logic
            let priorityBadge = '';
            if(r.payback < 3) priorityBadge = '<span class="badge badge-priority-high">Very High</span>';
            else if(r.payback < 7) priorityBadge = '<span class="badge badge-priority-med">High</span>';
            else priorityBadge = '<span class="badge badge-priority-low">Medium</span>';

            const status = isAffordable 
                ? `<span class="text-success fw-bold">‚úì Funded</span>` 
                : `<span class="text-muted">Over Budget</span>`;

            const row = `
                <tr class="${!isAffordable ? 'table-light text-muted' : ''}">
                    <td class="ps-4">${priorityBadge}</td>
                    <td class="fw-500">${r.name}</td>
                    <td>$${(r.cost).toLocaleString(undefined, {maximumFractionDigits:0})}</td>
                    <td>$${(r.savings).toLocaleString(undefined, {maximumFractionDigits:0})}</td>
                    <td>${r.payback.toFixed(1)} yrs</td>
                    <td>${status}</td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    function updateImpactPanel(oldU, newU) {
        const div = document.getElementById('impactDisplay');
        div.classList.remove('opacity-50');
        
        const calcDelta = (key, unit) => {
            const diff = newU[key] - oldU[key];
            if(Math.abs(diff) < 1) return '';
            const cls = diff > 0 ? 'text-up' : 'text-down';
            const arrow = diff > 0 ? '‚Üë' : '‚Üì';
            return `<div class="d-flex justify-content-between energy-delta mb-1">
                <span>${key.toUpperCase()}</span>
                <span class="${cls}">${arrow} ${Math.abs(diff).toLocaleString(undefined, {maximumFractionDigits:0})} ${unit}</span>
            </div>`;
        };

        div.innerHTML = `
            ${calcDelta('elec', 'kWh')}
            ${calcDelta('gas', 'Thm')}
            ${calcDelta('steam', 'Mlb')}
            ${calcDelta('oil2', 'Gal')}
            ${calcDelta('oil4', 'Gal')}
            <div class="mt-2 pt-2 border-top small text-muted text-center fst-italic">
                *Includes penalty savings
            </div>
        `;
    }
</script>
</body>
</html>
